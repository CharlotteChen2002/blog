<!DOCTYPE html><html><head><meta charset="utf-8"><title>CS61A 课程笔记 | llyのblog</title><meta name="description" content=" 本文主要记录学习 [CS61A SU20](https://inst.eecs.berkeley.edu/cs61a/su20/) 课程的一些感想 因为是课程笔记，所以基础知识不再赘述 实验，作业答案可见：[Writeups](https://github.com/xkz0777/CS61Asu20writeups/"><meta property="og:type" content="article"><meta property="og:title" content="CS61A 课程笔记"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="liuly"> <meta property="article:tag" content="函数式编程"> <meta property="article:tag" content="python">  </head><body><main style="display:none"> <p>本文主要记录学习 <a href="https://inst.eecs.berkeley.edu/~cs61a/su20/" target="_blank" rel="noopener">CS61A SU20</a> 课程的一些感想</p>
<p>因为是课程笔记，所以基础知识不再赘述</p>
<p>实验，作业答案可见：<a href="https://github.com/xkz0777/CS61A-su20-writeups/tree/liuly" target="_blank" rel="noopener">Writeups</a></p>
<h2 id="%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%AE%9A%E4%B9%89" tabindex="-1">函数式编程定义</h2>
<p>函数 <strong>可以</strong> 被作为参数传递，这是和面向过程相比最大的不同</p>
<p>它是一种声明式编程范式，其中函数是让输入值经过表达式树转换到输出值的映射，而不是更新程序运行状态的一系列命令式语句</p>
<p>这是在强调函数式编程的<strong>无副作用性</strong>：函数式编程有时被视为纯函数式编程的同义词，后者将所有函数视为确定性的数学函数（纯函数）。当使用一些给定参数调用纯函数时，它将始终返回相同的结果，并且不受任何可变状态（或其他副作用）的影响</p>
<!-- more -->
<h3 id="lambda-%E8%A1%A8%E8%BE%BE%E5%BC%8F" tabindex="-1">lambda 表达式</h3>
<p>可以看做一个匿名函数，从使用的角度来说，方便了函数的定义</p>
<h3 id="%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0" tabindex="-1">高阶函数</h3>
<p>(Higher-Order Functions) 指接受函数作为参数 <strong>或</strong> 返回值是函数的函数</p>
<h3 id="%E9%97%AD%E5%8C%85" tabindex="-1">闭包</h3>
<p>一个函数可以在另外一个函数中定义</p>
<p>如果一个定义在别的函数内部的函数被调用，那么这个函数被称为闭包。闭包使得可以合法的在函数外部获取函数内部的变量</p>
<p>例如：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">function</span><span style="color:#59873A;--shiki-dark:#80A665"> sumPrint</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">n</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    console</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">log</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">n</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    const</span><span style="color:#59873A;--shiki-dark:#80A665"> f</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> k</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#59873A;--shiki-dark:#80A665"> sumPrint</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">n</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#B07D48;--shiki-dark:#BD976A"> k</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> f</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">}</span></span></code></pre>
<p>其中 <code>f</code> 是一个 lambda 表达式。可以在控制台中调用：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">sumPrint</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">)(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">4</span><span style="color:#999999;--shiki-dark:#666666">)(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>得到：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-plaintext"><span class="line"><span>1</span></span>
<span class="line"><span>5</span></span>
<span class="line"><span>11</span></span></code></pre>
<p>顺利完成了求和工作。</p>
<p>其中 <code>f</code> 就体现出了闭包的作用，读取了 <code>sumPrint</code> 函数环境中的 <code>n</code></p>
<p>闭包需要保证调用 f 时其父环境存在，所以在 <code>sumPrint</code> 函数 <code>return f</code> 之后该 <code>sumPrint</code> 的环境仍然存在，并不会被销毁。</p>
<p>利用闭包还可以模拟类：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const</span><span style="color:#59873A;--shiki-dark:#80A665"> account</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">money</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">  const</span><span style="color:#59873A;--shiki-dark:#80A665"> withdraw</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">num</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">money</span><span style="color:#999999;--shiki-dark:#666666"> >=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> num</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">      money</span><span style="color:#AB5959;--shiki-dark:#CB7676"> -=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> num</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    }</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">    console</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">log</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">money</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">  }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">  return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> withdraw</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">}</span></span></code></pre>
<p>可以创建账户，返回一个取钱的方法。</p>
<h3 id="%E6%8A%BD%E8%B1%A1" tabindex="-1">抽象</h3>
<p>函数式编程的一个很大的好处就是它可以把不同的函数中相似的过程抽象出来进行封装。例如：</p>
<p>考虑连乘函数和连加函数，假设 <code>term</code> 是一个表示某个数列的函数，接受 <code>n</code> ，返回数列的第 <code>n</code> 项。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> product</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    product</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    while</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        product</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> product </span><span style="color:#AB5959;--shiki-dark:#CB7676">*</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">k</span><span style="color:#999999;--shiki-dark:#666666">),</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> product</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> summation</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    total</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    while</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        total</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> total </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">k</span><span style="color:#999999;--shiki-dark:#666666">),</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> total</span></span></code></pre>
<p>注意到 <code>summation</code> 和 <code>product</code> 大体结构是相似的。稍加封装：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> accumulate</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">combiner</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> base</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    total</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> base</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    while</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        total</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> combiner</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">total</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">k</span><span style="color:#999999;--shiki-dark:#666666">)),</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> k </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> total</span></span></code></pre>
<p>于是 <code>summation</code> 和 <code>product</code> 变得更加简洁：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> summation_using_accumulate</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> accumulate</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">add</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> product_using_accumulate</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> accumulate</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">mul</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> term</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>抽象的威力还在于它能解决一类问题。例如，我们考虑 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mi>n</mi></msup><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mo>⋯</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f^n(x)=f(f(f(f(\cdots f(x)))))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)))))</span></span></span></span></eq> ，<eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> 个 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></eq> 表示函数的 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> 次迭代，这实际上也是一个累积的过程，所以也可以调用 <code>accumulate</code> ，得到：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> compose</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">func1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> func2</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#AB5959;--shiki-dark:#CB7676"> lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> func1</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">func2</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">x</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> make_repeater</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">func</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> accumulate</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">compose</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> func</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p><code>compose</code> 是函数复合，于是 <code>make_repeater</code> 即可计算函数的 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> 次迭代，十分简洁优美。</p>
<h2 id="%E5%B0%BE%E9%80%92%E5%BD%92" tabindex="-1">尾递归</h2>
<h3 id="%E5%B0%BE%E8%B0%83%E7%94%A8" tabindex="-1">尾调用</h3>
<p>尾调用 (tail call) 是尾递归的基础。尾调用是对于一次函数调用而言的：如果 <code>foo()</code> 中 对 <code>bar()</code> 的调用是最后一条语句（也就是要么运行完 <code>bar()</code> 后 <code>foo()</code> 就退出，要么 <code>bar</code> 是 <code>foo()</code> 的返回值），那么这次调用是尾调用。</p>
<p>尾调用的好处在于无需保存 <code>foo()</code> 的信息：运行完 <code>bar()</code> 之后，可以直接将值返回调用 <code>foo()</code> 的函数。</p>
<p>如果一个函数尾调用了自己，那么这个调用就是尾递归的。尾递归的好处在于：通常情况下，调用一个新的函数会需要开辟新的函数栈，但是尾递归调用因为原函数的函数栈中信息已经无用，所以递归调用可以直接在原函数环境的基础上继续运算，不需要开辟新的空间。</p>
<p>尾递归使得一些函数的空间复杂度可以从 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq> 优化到与循环相同的 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O (1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq> 级别。例如：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> sum_digits_rec</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> digit_sum</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">  # border case</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> digit_sum</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">   	else</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> last </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> split</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> sum_digits_rec</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> digit_sum </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> last</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>这个函数用于利用计算一个正整数每个数位数字的和。按照通常的理解，这个函数对于长度为 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> 的整数会调用 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></eq> 次，每个函数调用都会开辟新的空间，空间复杂度 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O (n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></eq> ，但如果进行了尾递归优化，每次可以不开辟新的空间，空间复杂度来到了喜人的 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O (1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq></p>
<p>考虑计算 <code>sum_digits_rec(2013)</code></p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-mermaid"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">graph LR</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">1[201, 3]-->2[20, 4]-->3[2, 4]-->4[0, 6]-->6</span></span></code></pre>
<p>计算流程如图所示。</p>
<p>因此，在函数式编程中，递归可以成为替代循环的良好（也是最常见）手段</p>
<p>引用知乎上一个很好的回答：<a href="https://www.zhihu.com/question/20761771/answer/23254340" target="_blank" rel="noopener">什么是尾递归？ - 知乎</a> 来帮助理解</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">function</span><span style="color:#59873A;--shiki-dark:#80A665"> story</span><span style="color:#999999;--shiki-dark:#666666">()</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    // 从前有座山，山上有座庙，庙里有个老和尚，一天老和尚对小和尚讲故事：</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">    story</span><span style="color:#999999;--shiki-dark:#666666">()</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    // 尾递归，进入下一个函数不再需要上一个函数的环境了，得出结果以后直接返回。</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">}</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">function</span><span style="color:#59873A;--shiki-dark:#80A665"> story</span><span style="color:#999999;--shiki-dark:#666666">()</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    //从前有座山，山上有座庙，庙里有个老和尚，一天老和尚对小和尚讲故事：</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">    story</span><span style="color:#999999;--shiki-dark:#666666">()</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    // 小和尚听了，找了块豆腐撞死了 </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    // 非尾递归，下一个函数结束以后此函数还有后续，所以必须保存本身的环境以供处理返回值。</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">}</span></span></code></pre>
<h3 id="%E5%B0%BE%E9%80%92%E5%BD%92%E4%B8%8E%E5%BE%AA%E7%8E%AF" tabindex="-1">尾递归与循环</h3>
<p>通常而言，循环可以简单地转换成尾递归。只需要把循环中每次用于维持状态的变量写入递归函数的参数表中即可。例如，上面那个稍显复杂的尾递归计算所有数位数字之和的例子可以由如下的循环语句转换而来：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> split</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#AB5959;--shiki-dark:#CB7676">//</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 10</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#AB5959;--shiki-dark:#CB7676">%</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> sum_digits_iter</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    digit_sum </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    while</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#AB5959;--shiki-dark:#CB7676">></span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        n</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> last </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> split</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        digit_sum </span><span style="color:#999999;--shiki-dark:#666666">+=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> last</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> digit_sum</span></span></code></pre>
<h3 id="%E5%BA%94%E7%94%A8" tabindex="-1">应用</h3>
<p>考虑常见语言，C++ 编译器可以（但标准中并未要求）实现编译期间对尾递归的优化。所以以下的程序在编译选项设置得当的情况下不会造成栈溢出：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-cpp"><span class="line"><span style="color:#999999;--shiki-dark:#666666">#</span><span style="color:#1E754F;--shiki-dark:#4D9375">include</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> &#x3C;</span><span style="color:#B56959;--shiki-dark:#C98A7D">iostream</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#59873A;--shiki-dark:#80A665"> print</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> a</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	std</span><span style="color:#999999;--shiki-dark:#666666">::</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">cout </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;&#x3C;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> a</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	return</span><span style="color:#59873A;--shiki-dark:#80A665"> print</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#59873A;--shiki-dark:#80A665"> main</span><span style="color:#999999;--shiki-dark:#666666">()</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	print</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">}</span></span></code></pre>
<p>测试环境 <code>gcc version 11.2.0 (Ubuntu 11.2.0-7ubuntu2)</code> ，编译选项开启 -O2 后程序可以一直运行。</p>
<p>而 python 当前版本每次调用函数一定会新建一个环境，不会对尾递归进行优化（这似乎是因为 python 希望报错时保留完整的函数栈信息）</p>
<p>在一些偏向纯函数式的语言（如 Haskell，Scheme）中尾递归优化几乎是必须的：它们通常都会使用递归来代替循环。</p>
<p>在后文的 Scheme 解释器部分，将介绍如何实现一个支持尾递归优化的解释器。</p>
<h2 id="%E6%95%B0%E7%BB%84" tabindex="-1">数组</h2>
<p>很多时候，对于一个数组而言，我们希望将所有元素一一传递给某个函数，然后收集输出。</p>
<p>数组遍历有的时候就是在做这样的事情。我们现在用函数式编程的角度来看待这一问题，介绍一些在数组遍历时十分实用的高阶函数。</p>
<h3 id="map" tabindex="-1">Map</h3>
<p>python 中 map 的基本语法如下：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#998418;--shiki-dark:#B8A965">map</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">function_to_apply</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> list_of_inputs</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>会返回一个 map 对象（实际 map 类继承了 iterator 类，是一个迭代器）。可以通过 list 的构造函数转化成列表。</p>
<p>例如：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">items </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 3</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 4</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 5</span><span style="color:#999999;--shiki-dark:#666666">]</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">squared </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#998418;--shiki-dark:#B8A965"> list</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#998418;--shiki-dark:#B8A965">map</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#AB5959;--shiki-dark:#CB7676">**</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> items</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># [1, 4, 9, 16, 25]</span></span></code></pre>
<p>JavaScript 中的 map 语法则更加直接：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const</span><span style="color:#B07D48;--shiki-dark:#BD976A"> array1</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 4</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 9</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 16</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// pass a function to map</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const</span><span style="color:#B07D48;--shiki-dark:#BD976A"> map1</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> array1</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">map</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">x</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#B07D48;--shiki-dark:#BD976A"> x</span><span style="color:#AB5959;--shiki-dark:#CB7676"> *</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">console</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">log</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">map1</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// expected output: Array [2, 8, 18, 32]</span></span></code></pre>
<p>数组通过 map 方法返回一个新的数组。</p>
<p>如果不需要使用返回值（返回的数组），那么一般而言不使用 map 方法</p>
<h3 id="filter" tabindex="-1">Filter</h3>
<p>顾名思义，filter 创建一个函数返回 true 的元素列表。python 示例如下：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">number_list </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#998418;--shiki-dark:#B8A965"> range</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91">5</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 5</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">less_than_zero </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#998418;--shiki-dark:#B8A965"> list</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#998418;--shiki-dark:#B8A965">filter</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> number_list</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">print</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">less_than_zero</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Output: [-5, -4, -3, -2, -1]</span></span></code></pre>
<p>JavaScript 示例：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const</span><span style="color:#B07D48;--shiki-dark:#BD976A"> words</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">spray</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">limit</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">elite</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">exuberant</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">destruction</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">present</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const</span><span style="color:#B07D48;--shiki-dark:#BD976A"> result</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> words</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">filter</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">word</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#B07D48;--shiki-dark:#BD976A"> word</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#998418;--shiki-dark:#B8A965">length</span><span style="color:#999999;--shiki-dark:#666666"> ></span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 6</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">console</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">log</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">result</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// expected output: Array ["exuberant", "destruction", "present"]</span></span></code></pre>
<h3 id="reduce" tabindex="-1">Reduce</h3>
<p>Reduce 是一个非常有用的函数，用于在数组上执行一些计算并返回 <strong>一个</strong> 结果。它对数组中的相邻元素 ''滚动'' 计算。例如，如果需要计算整数列表的乘积：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">from</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> functools </span><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#B07D48;--shiki-dark:#BD976A"> reduce</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">product </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> reduce</span><span style="color:#999999;--shiki-dark:#666666">((</span><span style="color:#AB5959;--shiki-dark:#CB7676">lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> y</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x </span><span style="color:#AB5959;--shiki-dark:#CB7676">*</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> y</span><span style="color:#999999;--shiki-dark:#666666">),</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 3</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 4</span><span style="color:#999999;--shiki-dark:#666666">])</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Output: 24</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">product </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> reduce</span><span style="color:#999999;--shiki-dark:#666666">((</span><span style="color:#AB5959;--shiki-dark:#CB7676">lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> y</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x </span><span style="color:#AB5959;--shiki-dark:#CB7676">*</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> y</span><span style="color:#999999;--shiki-dark:#666666">),</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 3</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 4</span><span style="color:#999999;--shiki-dark:#666666">],</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 5</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Output: 120 = 5 * 1 * 2 * 3 * 4</span></span></code></pre>
<p>有点类似于 Verilog HDL 中的归约运算符，但显然更加强大。最后一句是设置初值的示例。</p>
<p>JavaScript 中的 reduce：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-javascript"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const</span><span style="color:#B07D48;--shiki-dark:#BD976A"> array1</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 2</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 3</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 4</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const</span><span style="color:#59873A;--shiki-dark:#80A665"> reducer</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">previousValue</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> currentValue</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#B07D48;--shiki-dark:#BD976A"> previousValue</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#B07D48;--shiki-dark:#BD976A"> currentValue</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// 1 + 2 + 3 + 4</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">console</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">log</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">array1</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">reduce</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">reducer</span><span style="color:#999999;--shiki-dark:#666666">));</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// expected output: 10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// 5 + 1 + 2 + 3 + 4</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">console</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">log</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">array1</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">reduce</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">reducer</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 5</span><span style="color:#999999;--shiki-dark:#666666">));</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// expected output: 15</span></span></code></pre>
<h3 id="%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%BC%8F" tabindex="-1">列表推导式</h3>
<p>(List Comprehension)</p>
<p>在 python 中，对数组进行操作有更为简便的方法：列表推导式。</p>
<p>List Comprehension 是 map() 和 filter() 的一种替代品。它遵循数学上集合构建的形式，提供了一种创建列表的简洁方法。语法如下：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expression </span><span style="color:#1E754F;--shiki-dark:#4D9375">for</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> item </span><span style="color:#1E754F;--shiki-dark:#4D9375">in</span><span style="color:#998418;--shiki-dark:#B8A965"> list</span><span style="color:#1E754F;--shiki-dark:#4D9375"> if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> conditional</span><span style="color:#999999;--shiki-dark:#666666">]</span></span></code></pre>
<p>对 list 中的每个 item 而言，如果 conditional 条件满足，就将 expression 值加人数组。</p>
<p>很容易看出，省略 conditional 或者 expression 取 item，列表推导就会退化为 map 或 filter</p>
<p>列表推导式使用得当可以轻松完成一些复杂的目标。例如得到 0 到 100 的所有偶数：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">2</span><span style="color:#AB5959;--shiki-dark:#CB7676"> *</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#1E754F;--shiki-dark:#4D9375">for</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#1E754F;--shiki-dark:#4D9375">in</span><span style="color:#998418;--shiki-dark:#B8A965"> range</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">51</span><span style="color:#999999;--shiki-dark:#666666">)]</span></span></code></pre>
<p>又例如我想得到一个数组中所有 25 的因子：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">numbers </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">3</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">4</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">5</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">6</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">7</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2F798A;--shiki-dark:#4C9A91">10</span><span style="color:#999999;--shiki-dark:#666666">]</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">n </span><span style="color:#1E754F;--shiki-dark:#4D9375">for</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#1E754F;--shiki-dark:#4D9375">in</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> numbers </span><span style="color:#1E754F;--shiki-dark:#4D9375">if</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 25</span><span style="color:#AB5959;--shiki-dark:#CB7676"> %</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">]</span></span></code></pre>
<p>输出 <code>[1, 5]</code></p>
<p>因此可以设计一个获取一个数所有因子的函数：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">factors </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#AB5959;--shiki-dark:#CB7676"> lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i </span><span style="color:#1E754F;--shiki-dark:#4D9375">for</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#1E754F;--shiki-dark:#4D9375">in</span><span style="color:#998418;--shiki-dark:#B8A965"> range</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> n </span><span style="color:#AB5959;--shiki-dark:#CB7676">%</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">]</span></span></code></pre>
<h3 id="python-%E4%B8%AD%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8" tabindex="-1">python 中的迭代器</h3>
<p>python 之所以 map 和 reduce 操作设计的稍显繁琐，很大一部分原因正如上文在 map 中所述，是 python 希望这些列表操作的高阶函数能返回一个迭代器对象。</p>
<p>迭代器这个概念在很多语言中都有，但是 python 中这些列表操作的高阶函数（map, reduce, zip, sum, all, any 等）返回的迭代器（以及别的一些常见的自带迭代器，比如 range）的特别之处在于它们是懒加载的：意思是并不会一次性算出返回的列表，而只是每次需要用到迭代器的时候往后计算一个值。</p>
<p>这么说可能有点抽象，下面举一个实际一点的例子：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> sum_from_a_to_b</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> b</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#998418;--shiki-dark:#B8A965"> sum</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#998418;--shiki-dark:#B8A965">range</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> b </span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">))</span></span></code></pre>
<p>这个函数用于计算从 a 到 b 的自然数之和。单从代码的字面意思理解，我们可能会认为这段代码先生成 <code>range(a, b + 1)</code> ，一个长为 b - a + 1 的数组，然后再对这个数组应用 sum 方法。如此一来，空间复杂度为 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Θ</mi><mo stretchy="false">(</mo><mi>b</mi><mo>−</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Theta(b-a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Θ</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></eq> 的线性复杂度。</p>
<p>但实际上 python 在运行代码的时候不会这样处理。而是首先 sum 函数需要获取第一个值，于是 range 才返回第一个值 a，随后 sum 需要获取第二个值，range 再返回第二个值 a + 1，以此类推。不难发现这等效于下面的代码：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> sum_from_a_to_b</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> b</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">    sum</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    while</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> a </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> b</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">        sum</span><span style="color:#999999;--shiki-dark:#666666"> +=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> a</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        a </span><span style="color:#999999;--shiki-dark:#666666">+=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#998418;--shiki-dark:#B8A965"> sum</span></span></code></pre>
<p>空间复杂度为非常漂亮的 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Θ</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Theta(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Θ</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq> 常数级别。</p>
<h2 id="%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB" tabindex="-1">编辑距离</h2>
<p><s>插播一道算法题</s></p>
<p>来自于 <a href="https://inst.eecs.berkeley.edu/~cs61a/su20/proj/cats/" target="_blank" rel="noopener">Project2 - Cats</a> ，Problem 7。实际就是在求两个字符串直接的编辑距离，与 <a href="https://leetcode-cn.com/problems/edit-distance/" target="_blank" rel="noopener">Leetcode 72</a> 相同，题目如下：</p>
<p>给你两个单词 word1 和 word2，请你计算出将 word1 转换成 word2 所使用的最少操作数。</p>
<p>你可以对一个单词进行如下三种操作：</p>
<ul>
<li>插入一个字符</li>
<li>删除一个字符</li>
<li>替换一个字符</li>
</ul>
<p>编辑距离实际上有几种不同的定义，差异在可以对字符串进行的处理。在莱文斯坦距离中，可以删除、加入、取代字符串中的任何一个字元，这也就是本文讨论的编辑距离。常常提到编辑距离时，指的就是莱文斯坦距离。</p>
<h3 id="%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90" tabindex="-1">问题分析</h3>
<p>很容易想到的是暴力检查所有可能的编辑方法，取最短的一个。但这样计算复杂度会达到指数级别，并且我们只需要找到编辑距离（最短序列的长度），不需要找到所有编辑序列。</p>
<p>问题的核心在于如何简化这一问题。举个例子，purng 和 purring，前者相比后者缺少了 r 和 i 两个字符，编辑距离为 2。用搜索的观点看待，我们可能会认为应该枚举增加 r 增加 i 和增加 i 增加 r 这两种方式，但这两种方式结果是一致的：编辑操作之间顺序的交换并不会影响编辑的结果。因此，我们希望“统一”这两种操作。</p>
<p>这一点 git 的 diff 可以给我们带来很好的参考。 <a href="https://zhuanlan.zhihu.com/p/34640058" target="_blank" rel="noopener">来自知乎</a>：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-plaintext"><span class="line"><span>编辑序列, - 代表删除 / + 代表插入(注意空行）</span></span>
<span class="line"><span>------------------------------------------</span></span>
<span class="line"><span> |#include &#x3C;iostream>          </span></span>
<span class="line"><span> |using namespace std;</span></span>
<span class="line"><span>-|</span></span>
<span class="line"><span>-|int main() { </span></span>
<span class="line"><span>+|void hello() {</span></span>
<span class="line"><span> |    cout &#x3C;&#x3C; "hello world" &#x3C;&#x3C; endl;</span></span>
<span class="line"><span> |}</span></span>
<span class="line"><span> |</span></span>
<span class="line"><span>+|int main() {      </span></span>
<span class="line"><span>+|    hello();</span></span>
<span class="line"><span>+|}</span></span>
<span class="line"><span>------------------------------------------</span></span></code></pre>
<p>git 的 diff 是行与行之间的比较，且没有替换操作。但一目了然的是，对于一个编辑序列，我们可以将每个编辑操作按照它在原文本修改的位置进行排序，这样一来编辑操作进行的先后顺序也就无关紧要了。</p>
<p>以 ckiteus 和 kittens 为例，写出编辑距离对应的编辑序列：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-plaintext"><span class="line"><span>编辑序列, - 代表删除 / + 代表插入 / r 代表替换</span></span>
<span class="line"><span>------------------------------------------</span></span>
<span class="line"><span>-|c</span></span>
<span class="line"><span> |k </span></span>
<span class="line"><span> |i</span></span>
<span class="line"><span> |t</span></span>
<span class="line"><span>+|t</span></span>
<span class="line"><span> |e</span></span>
<span class="line"><span>r|n (&#x3C;--u)      </span></span>
<span class="line"><span> |s</span></span>
<span class="line"><span>------------------------------------------</span></span></code></pre>
<p>我们想找到两个字符串的编辑距离，只需要对这个编辑距离对应的编辑序列分类讨论：</p>
<ul>
<li>编辑序列以 <code>-</code> 开头：同上序列所示，此种情况下，剩下的操作实际是把 kiteus 编辑成 kittens，所以 ckiteus 和 kittens 的编辑距离 = kiteus 和 kittens 的编辑距离 + 1</li>
<li>编辑序列以 <code>+</code> 开头：以 ctopu 和 octopus 为例，编辑序列中 <code>+|o</code> 之后的操作对应 ptopu 和 ptopus 的编辑距离。所以所求 = ctopu 和 ctopus 的编辑距离 + 1</li>
<li>编辑序列以 <code>r</code> 开头：以 oampud 和 campus 为例，编辑序列中 <code>r|c (&lt;--o)</code> 之后的操作对应 ampud 和 ampus 的编辑距离。所以所求 = ampud 和 ampus 的编辑距离 + 1</li>
<li>编辑距离以空操作开头。则直接忽略这一字符，去往下一个即可。</li>
</ul>
<p>以上操作可以用函数递归调用表示。分别枚举这几种情况，补上 base case 即可。</p>
<p>于是 Cats 中 <code>meowstake_matches</code> 的代码呼之欲出：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> meowstake_matches</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span><span style="color:#B56959;--shiki-dark:#C98A7D">A diff function that computes the edit distance from START to GOAL.</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> start </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> ''</span><span style="color:#AB5959;--shiki-dark:#CB7676"> or</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> ''</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">	# base case</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#998418;--shiki-dark:#B8A965"> max</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#998418;--shiki-dark:#B8A965">len</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">),</span><span style="color:#998418;--shiki-dark:#B8A965"> len</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">goal</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    else</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> start</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#AB5959;--shiki-dark:#CB7676"> ==</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">]:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> meowstake_matches</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:],</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:])</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        add_diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> meowstake_matches</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:])</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        remove_diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> meowstake_matches</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:],</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        substitute_diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> meowstake_matches</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:],</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:])</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#998418;--shiki-dark:#B8A965"> min</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">add_diff</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> remove_diff</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> substitute_diff</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span></code></pre>
<p>（实际 Cats 代码由于还有 limit 参数，与这略有不同）</p>
<h3 id="%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92" tabindex="-1">动态规划</h3>
<p>上面的代码实际涉及了很多重复计算：同一个 <code>start[i1:len1]</code> 和 <code>goal[i2,len2]</code> 可以由 <code>start[i1 - 1:len1]</code> 和 <code>goal[i2 - 1,len2]</code> 由三种不同方式得到。累计起来考虑，时间复杂度达到了指数级别。我们采用动态规划解决这一问题。这里我们采用备忘录，对已经搜索好的结果进行记录：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> meowstake_matches</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span><span style="color:#B56959;--shiki-dark:#C98A7D">A diff function that computes the edit distance from START to GOAL.</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"""</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    memo </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#998418;--shiki-dark:#B8A965"> dict</span><span style="color:#999999;--shiki-dark:#666666">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    def</span><span style="color:#59873A;--shiki-dark:#80A665"> recur</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> start </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> ''</span><span style="color:#AB5959;--shiki-dark:#CB7676"> or</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> ''</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">  # base case</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#998418;--shiki-dark:#B8A965"> max</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#998418;--shiki-dark:#B8A965">len</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">),</span><span style="color:#998418;--shiki-dark:#B8A965"> len</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">goal</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        else</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> memo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">get</span><span style="color:#999999;--shiki-dark:#666666">((</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">)):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">                return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> memo</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">get</span><span style="color:#999999;--shiki-dark:#666666">((</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            skip </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#1E754F;--shiki-dark:#4D9375"> if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> start</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#AB5959;--shiki-dark:#CB7676"> !=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#1E754F;--shiki-dark:#4D9375"> else</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            add_diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> recur</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:])</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            remove_diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> recur</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:],</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            substitute_diff </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> recur</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:],</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">1</span><span style="color:#999999;--shiki-dark:#666666">:])</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> skip</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            memo</span><span style="color:#999999;--shiki-dark:#666666">[(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">)]</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#998418;--shiki-dark:#B8A965"> min</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">add_diff</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> remove_diff</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> substitute_diff</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> memo</span><span style="color:#999999;--shiki-dark:#666666">[(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">)]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> recur</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">start</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> goal</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>这里直接丢了个字典，理论上字典查找的时间复杂度也是 <eq><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></eq> ，但如果更要追求效率，那可以采用递推的方法计算 dp 数组。此时，为了方便对齐下标起见，我们考虑两个字符串的子串：<code>word1[0:i]</code> 和 <code>word2[0:j]</code> ，把它们的编辑距离记为 <code>m[i][j]</code> ，则类似讨论编辑序列的最后一项操作，可以得到 dp 关系式。</p>
<p>当 <code>word1[i-1] == word2[j-1]</code> ：</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>=</mo><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">m[i][j] = m[i-1][j-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span></eqn></section><p>否则：</p>
<section><eqn><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>=</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">m[i][j] = min(m[i-1][j-1], m[i][j-1], m[i-1][j]) + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">min</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">])</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></span></eqn></section><p>据此可以编写出通过 Leetcode 72 的 cpp 版本动态规划代码：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-cpp"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Solution</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">public</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    int</span><span style="color:#59873A;--shiki-dark:#80A665"> mDistance</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#B07D48;--shiki-dark:#BD976A"> word1</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> string</span><span style="color:#B07D48;--shiki-dark:#BD976A"> word2</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">        int</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> len1 </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> word1</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">size</span><span style="color:#999999;--shiki-dark:#666666">(),</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> len2 </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A"> word2</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">size</span><span style="color:#999999;--shiki-dark:#666666">();</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">        int</span><span style="color:#B07D48;--shiki-dark:#BD976A"> m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">501</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#2F798A;--shiki-dark:#4C9A91">501</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        // i, j refer to pick how many chars from word1 and word2</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> len1</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i</span><span style="color:#AB5959;--shiki-dark:#CB7676">++</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> j </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> len2</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i</span><span style="color:#AB5959;--shiki-dark:#CB7676">++</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">            m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> j</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> len1</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> i</span><span style="color:#AB5959;--shiki-dark:#CB7676">++</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            for</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#AB5959;--shiki-dark:#CB7676">int</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> j </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> j </span><span style="color:#AB5959;--shiki-dark:#CB7676">&#x3C;=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> len2</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> j</span><span style="color:#AB5959;--shiki-dark:#CB7676">++</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">                if</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">word1</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#AB5959;--shiki-dark:#CB7676"> ==</span><span style="color:#B07D48;--shiki-dark:#BD976A"> word2</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">])</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                    m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                }</span><span style="color:#1E754F;--shiki-dark:#4D9375"> else</span><span style="color:#999999;--shiki-dark:#666666"> {</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">                    m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j</span><span style="color:#999999;--shiki-dark:#666666">]</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#59873A;--shiki-dark:#80A665"> min</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">],</span><span style="color:#B07D48;--shiki-dark:#BD976A"> m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">],</span><span style="color:#B07D48;--shiki-dark:#BD976A"> m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">i </span><span style="color:#AB5959;--shiki-dark:#CB7676">-</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">j</span><span style="color:#999999;--shiki-dark:#666666">])</span><span style="color:#AB5959;--shiki-dark:#CB7676"> +</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">                }</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">            }</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">        }</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> m</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">len1</span><span style="color:#999999;--shiki-dark:#666666">][</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">len2</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    }</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">};</span></span></code></pre>
<h2 id="scheme-%E8%A7%A3%E9%87%8A%E5%99%A8" tabindex="-1">Scheme 解释器</h2>
<p>本部分记录 CS61A 课程的精华（？）Scheme 解释器的编写（使用 Python）。</p>
<p>su20 学期有一个 Challenge 版本，提供的代码较少，这里选择 <a href="https://inst.eecs.berkeley.edu/~cs61a/su20/proj/scheme_stubbed/" target="_blank" rel="noopener">Challenge 版本</a></p>
<p>本次实验中可交互的语言解释器的主体框架是 REPL 模式：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-mermaid"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">graph LR</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">Read-->Eval-->Print--loop-->Read</span></span></code></pre>
<p>本次实验已经提供了读入用户输入后的分词（tokenization）和词法分析（lexical analysis）部分的实现，也就是说我们需要完成的部分的输入仅有以下几种可能：</p>
<ul>
<li>number: int or float</li>
<li>symbol: string</li>
<li>boolean: bool</li>
<li>unspecified: None</li>
</ul>
<p>（右边是输入的 Python 类型）</p>
<p>而无须担心分词处理，例如如何把 1.3 识别成小数。</p>
<h3 id="read" tabindex="-1">Read</h3>
<p><s>处理 Scheme 输入就是在做括号匹配</s></p>
<p>此部分要求将 Tokens 的输入转化成合法的 Scheme 表达式。</p>
<p>这里通过两个互相递归调用对方的函数：<code>scheme_read</code> 和 <code>read_tail</code> 实现。前者用于从 Tokens 的 Buffer 中读取一个表达式，后者则读到第一个右括号就停止，返回读到的表达式。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> scheme_read</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span><span style="color:#B56959;--shiki-dark:#C98A7D">Read the next expression from SRC, a Buffer of tokens.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">scheme_read(Buffer(tokenize_lines(['nil'])))</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    nil</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">scheme_read(Buffer(tokenize_lines(['1'])))</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">scheme_read(Buffer(tokenize_lines(['true'])))</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    True</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">scheme_read(Buffer(tokenize_lines(['(+ 1 2)'])))</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    Pair('+', Pair(1, Pair(2, nil)))</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">current</span><span style="color:#999999;--shiki-dark:#666666">()</span><span style="color:#AB5959;--shiki-dark:#CB7676"> is</span><span style="color:#1E754F;--shiki-dark:#4D9375"> None</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        raise</span><span style="color:#998418;--shiki-dark:#B8A965"> EOFError</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    # BEGIN PROBLEM 1/2</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    "</span><span style="color:#B56959;--shiki-dark:#C98A7D">*** YOUR CODE HERE ***</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    first_token </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pop_first</span><span style="color:#999999;--shiki-dark:#666666">()</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> first_token </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">nil</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> nil</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    elif</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> first_token </span><span style="color:#AB5959;--shiki-dark:#CB7676">not</span><span style="color:#AB5959;--shiki-dark:#CB7676"> in</span><span style="color:#A65E2B;--shiki-dark:#C99076"> DELIMITERS</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> first_token</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    elif</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> first_token </span><span style="color:#AB5959;--shiki-dark:#CB7676">==</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> read_tail</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    else</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        raise</span><span style="color:#998418;--shiki-dark:#B8A965"> SyntaxError</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">unexpected token: </span><span style="color:#A65E2B;--shiki-dark:#C99076">{0}</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">format</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">first_token</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    # END PROBLEM 1/2</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> read_tail</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span><span style="color:#B56959;--shiki-dark:#C98A7D">Return the remainder of a list in SRC, starting before an element or ).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">read_tail(Buffer(tokenize_lines([')'])))</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    nil</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">read_tail(Buffer(tokenize_lines(['2 3)'])))</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    Pair(2, Pair(3, nil))</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    try</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">current</span><span style="color:#999999;--shiki-dark:#666666">()</span><span style="color:#AB5959;--shiki-dark:#CB7676"> is</span><span style="color:#1E754F;--shiki-dark:#4D9375"> None</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            raise</span><span style="color:#998418;--shiki-dark:#B8A965"> SyntaxError</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">unexpected end of file</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        # BEGIN PROBLEM 1</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">        "</span><span style="color:#B56959;--shiki-dark:#C98A7D">*** YOUR CODE HERE ***</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> src</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">current</span><span style="color:#999999;--shiki-dark:#666666">()</span><span style="color:#AB5959;--shiki-dark:#CB7676"> ==</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">)</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            src</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">pop_first</span><span style="color:#999999;--shiki-dark:#666666">()</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> nil</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Pair</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">scheme_read</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">),</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> read_tail</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">src</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        # END PROBLEM 1</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    except</span><span style="color:#998418;--shiki-dark:#B8A965"> EOFError</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        raise</span><span style="color:#998418;--shiki-dark:#B8A965"> SyntaxError</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">unexpected end of file</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<h3 id="eval" tabindex="-1">Eval</h3>
<p>在读取完 tokens 生成表达式后，接下来要做的就是语法分析，确定具体如何执行（或者这里翻译成计算可能更为贴切）表达式。</p>
<p>主体仍然是两个函数的互相调用：<code>Scheme_eval</code> 和 <code>Scheme_apply</code></p>
<p>前者顾名思义，是计算表达式值的主要函数：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> scheme_eval</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> _</span><span style="color:#AB5959;--shiki-dark:#CB7676">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">None</span><span style="color:#999999;--shiki-dark:#666666">):</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">  # Optional third argument is ignored</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span><span style="color:#B56959;--shiki-dark:#C98A7D">Evaluate Scheme expression EXPR in environment ENV.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">expr = read_line('(+ 2 2)')</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">expr</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    Pair('+', Pair(2, Pair(2, nil)))</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    >>> </span><span style="color:#B56959;--shiki-dark:#C98A7D">scheme_eval(expr, create_global_frame())</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    4</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    # atom, 原子，直接计算即可</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> self_evaluating</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> expr</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    elif</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_symbolp</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">lookup</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">    # combination 特殊形式或者函数调用</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#AB5959;--shiki-dark:#CB7676"> not</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_listp</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        raise</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> SchemeError</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#A65E2B;--shiki-dark:#C99076">{0}</span><span style="color:#B56959;--shiki-dark:#C98A7D"> is not an expression</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">format</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    first</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> rest </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> expr</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">first</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> expr</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rest</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_symbolp</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">first</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> and</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> first </span><span style="color:#AB5959;--shiki-dark:#CB7676">in</span><span style="color:#A65E2B;--shiki-dark:#C99076"> SPECIAL_FORMS</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#A65E2B;--shiki-dark:#C99076"> SPECIAL_FORMS</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">first</span><span style="color:#999999;--shiki-dark:#666666">](</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    else</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">                                                    # call</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        operator </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_eval</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">first</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        args </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> rest</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">map</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">lambda</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_eval</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">x</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_apply</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">operator</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> args</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>对于原子，可以直接计算出它们的值（原子也正是这么定义的），可能是字面常量或者是变量，如果是变量直接到环境中找到绑定的值即可。</p>
<p>对于特殊形式 (if, and, begin...) 而言，分别对应着不同的处理逻辑，出于简洁考虑，这里用一个字典映射到对应的处理函数并调用。</p>
<p>如果计算出了一个操作符 (operator) ，那么在计算完操作数 (oprands) 后需要交给 <code>scheme_apply</code> 来模拟函数调用操作：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> scheme_apply</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">procedure</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> args</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#B5695977;--shiki-dark:#C98A7D77">    """</span><span style="color:#B56959;--shiki-dark:#C98A7D">Apply Scheme PROCEDURE to argument values ARGS (a Scheme list) in</span></span>
<span class="line"><span style="color:#B56959;--shiki-dark:#C98A7D">    environment ENV.</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"""</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">    validate_procedure</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">procedure</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    if</span><span style="color:#998418;--shiki-dark:#B8A965"> isinstance</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">procedure</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> BuiltinProcedure</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> procedure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">apply</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">args</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    elif</span><span style="color:#998418;--shiki-dark:#B8A965"> isinstance</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">procedure</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> LambdaProcedure</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">        # formals 与 args 的值相对应，再创建新环境</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        formals </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> procedure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">formals</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">to_list</span><span style="color:#999999;--shiki-dark:#666666">()</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        args </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> args</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">to_list</span><span style="color:#999999;--shiki-dark:#666666">()</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#998418;--shiki-dark:#B8A965"> len</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">formals</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> !=</span><span style="color:#998418;--shiki-dark:#B8A965"> len</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">args</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            raise</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> SchemeError</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">Incorrect number of arguments to function call</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        curr_envi </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Frame</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">env</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> if</span><span style="color:#998418;--shiki-dark:#B8A965"> isinstance</span><span style="color:#999999;--shiki-dark:#666666">(</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            procedure</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> MuProcedure</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> else</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Frame</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">procedure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        for</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> formal</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> arg </span><span style="color:#1E754F;--shiki-dark:#4D9375">in</span><span style="color:#998418;--shiki-dark:#B8A965"> zip</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">formals</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> args</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            curr_envi</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">define</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">formal</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> arg</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        expr </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> procedure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">body</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        while</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> expr</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rest </span><span style="color:#AB5959;--shiki-dark:#CB7676">is</span><span style="color:#AB5959;--shiki-dark:#CB7676"> not</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> nil</span><span style="color:#999999;--shiki-dark:#666666">:</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            scheme_eval</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">first</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> curr_envi</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            expr </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> expr</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">rest</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_eval</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">first</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> curr_envi</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#1E754F;--shiki-dark:#4D9375"> True</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>Scheme 中，用户自定义的函数都是 lambda 函数，所以只需要分别处理内置函数的调用和 lambda 函数的调用即可。后者需要创建新的环境。</p>
<p>至此主体部分很愉悦的就结束了。下面介绍一些有意思的功能的实现。</p>
<h3 id="mu" tabindex="-1">Mu</h3>
<p>Scheme 中，函数作用域默认是 lexical scope，也就是函数调用时的环境取决于定义的位置。这里是实现了一个新的 <code>MuProcudure</code> ，函数调用时的环境取决于调用的位置。</p>
<p>其实只有环境的评估不同，所以直接偷懒一点让 <code>MuProcedure</code> 继承 <code>LambdaProcedure</code> 然后在上面的 <code>apply</code> 函数中加一个逻辑</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">curr_envi </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Frame</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">env</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> if</span><span style="color:#998418;--shiki-dark:#B8A965"> isinstance</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">procedure</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> MuProcedure</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> else</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Frame</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">procedure</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>就好了。</p>
<h3 id="%E5%B0%BE%E9%80%92%E5%BD%92-1" tabindex="-1">尾递归</h3>
<p>为了支持尾递归，我们可能需要进行的是更广义的尾调用优化。这里参考官方文档可能是一个有效的方式：<a href="http://www.r6rs.org/final/html/r6rs/r6rs-Z-H-14.html#node_sec_11.20" target="_blank" rel="noopener">R6RS 的文档</a></p>
<p>Scheme 中对尾调用引入了一个 tail context 的概念，这个概念是自顶向下递归定义的。对于每个控制计算顺序的过程，都有自己的 tail context，也就是这个过程中最后计算的部分</p>
<p>例如，对于 <code>(if (cond) (a) (b))</code> 而言，<code>a</code> 和 <code>b</code> 都会是最后计算的（因为只择其一），所以都是 tail context</p>
<p>而对于 <code>(begin (a) (b) (c))</code> 而言，只有 <code>c</code> 是最后计算的，所以 <code>c</code> 是 tail context</p>
<p>最主要的，由于函数调用是 lambda 表达式的调用，所以 <code>(lambda (formals) (a) (b) ... (x))</code> 中的 <code>x</code> 也是 tail context</p>
<p>这就启示了我们如何编写支持尾递归的解释器：对于所有 tail context，我们都采取“懒求值”策略，返回的是 tail context 的表达式和当前环境，之后再对新的环境和新的表达式求值。如果说原先的尾递归是通过 DFS 逐层深入到最底层后再返回结果，现在的尾递归就相当于维护一个长度始终为 1 的 BFS 队列（只保存每次新加入的 Thunk 结点，之前的结点不会再参与计算），因而只占用常数空间</p>
<p>注意到这样事实上囊括了所有可能的尾调用。所以甚至以下互相的递归调用也是可以被优化的（指不会内存占满）：</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-scheme"><span class="line"><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">define</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#59873A;--shiki-dark:#80A665">a</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    (</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">b x</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#1E754F;--shiki-dark:#4D9375">define</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#59873A;--shiki-dark:#80A665">b</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> x</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">    (</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a x</span><span style="color:#999999;--shiki-dark:#666666">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">a </span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">)</span></span></code></pre>
<p>有了思路之后实现起来就比较简单了。</p>
<pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code class="language-python"><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">class</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Thunk</span><span style="color:#999999;--shiki-dark:#666666">():</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    def</span><span style="color:#998418;--shiki-dark:#B8A965"> __init__</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">self</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> expr</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">        self</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> expr</span></span>
<span class="line"><span style="color:#A65E2B;--shiki-dark:#C99076">        self</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">env </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">def</span><span style="color:#59873A;--shiki-dark:#80A665"> optimize_tail_calls</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">prior_eval_function</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">    def</span><span style="color:#59873A;--shiki-dark:#80A665"> optimized_eval</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> tail</span><span style="color:#AB5959;--shiki-dark:#CB7676">=</span><span style="color:#1E754F;--shiki-dark:#4D9375">False</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        if</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> tail </span><span style="color:#AB5959;--shiki-dark:#CB7676">and</span><span style="color:#AB5959;--shiki-dark:#CB7676"> not</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> scheme_symbolp</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> and</span><span style="color:#AB5959;--shiki-dark:#CB7676"> not</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> self_evaluating</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">            return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Thunk</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">        result </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Thunk</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        while</span><span style="color:#998418;--shiki-dark:#B8A965"> isinstance</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">result</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> Thunk</span><span style="color:#999999;--shiki-dark:#666666">):</span></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">            result </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> prior_eval_function</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">result</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">expr</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> result</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">env</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">        return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> result</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">    return</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> optimized_eval</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">scheme_eval </span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> optimize_tail_calls</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">scheme_eval</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> # !!!</span></span></code></pre>
<p>这里把原先的 <code>scheme_eval</code> 替换成 <code>optimized_eval</code> ，当显式指定 <code>tail=True</code> 时，也就是计算到 tail context 时，返回一个 Thunk 对象。这里不必要深究 Thunk 的含义，可以简单理解成这是一个保存了当前要计算的表达式及其所在环境的结构体。</p>
<p><code>eval</code> 只需要循环计算到返回对象不是 Thunk 对象了即可。尾调用的优化是在函数调用，也就是 lambda 表达式的调用过程中实现的，在返回新的 Thunk 对象后，原函数环境不再需要，会自动回收。</p>
 </main><script type="text/javascript">var main=document.querySelector("main"),content=main.innerHTML;sessionStorage.setItem("cs61a",content),sessionStorage.setItem("cs61a__time",Date.now().toString());var pathSegmentsToKeep=0,l=window.location;l.replace(l.protocol+"//"+l.hostname+(l.port?":"+l.port:"")+l.pathname.split("/").slice(0,1+pathSegmentsToKeep).join("/")+"/?/"+l.pathname.slice(1).split("/").slice(pathSegmentsToKeep).join("/").replace(/&/g,"~and~")+(l.search?"&"+l.search.slice(1).replace(/&/g,"~and~"):"")+l.hash)</script></body></html>